#!/usr/bin/env bash

set -ex

meson . ./build --buildtype=debugoptimized -Dgc=true -Dprof=true "$@"

cd ./build

ninja || true

ninja install

cd ../.travis

ulimit -c unlimited -S

npm install

npm run -s test || RESULT=$?

[[ ${RESULT} -eq 0 ]] && exit 0

for i in $(find ./ -maxdepth 1 -name 'core*' -print)
do gdb urbit core* -ex "thread apply all bt" -ex "set pagination 0" -batch
done

echo "build failed with status code $RESULT"

exit $RESULT
